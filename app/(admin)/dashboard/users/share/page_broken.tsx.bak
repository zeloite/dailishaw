"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import {
  ArrowLeft,
  Share2,
  Eye,
  EyeOff,
  Copy,
  Check,
  Edit2,
} from "lucide-react";
import { Button } from "@/components/ui/Button";
import { Card, CardContent } from "@/components/ui/Card";
import DashboardLayout from "@/components/DashboardLayout";
import { createClient } from "@/lib/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/Dialog";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";
import { updateUserPasswordAction } from "./actions";

const navigationItems = [
  {
    icon: "/ix-user-management.svg",
    label: "User Management",
    active: true,
    href: "/dashboard/users",
  },
  {
    icon: "/pajamas-media.svg",
    label: "Media Management",
    active: false,
    href: "/dashboard/categories",
  },
  {
    icon: "/game-icons-expense.svg",
    label: "Expense Monitoring",
    active: false,
    href: "/dashboard/expenses",
  },
];

interface User {
  id: string;
  user_id: string;
  display_name: string | null;
  email: string;
  plain_password: string | null;
}

export default function ShareCredentialsPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [visiblePasswords, setVisiblePasswords] = useState<
    Record<string, boolean>
  >({});
  const [copiedItems, setCopiedItems] = useState<Record<string, boolean>>({});
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<User | null>(null);
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [updating, setUpdating] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  const router = useRouter();

  useEffect(() => {
    fetchUsers();
  }, []);

  const fetchUsers = async () => {
    try {
      const supabase = createClient();
      const { data, error } = await supabase
        .from("profiles")
        .select("id, user_id, display_name, plain_password")
        .eq("role", "user")
        .eq("is_active", true)
        .order("created_at", { ascending: false });

      if (error) throw error;

      // Get email from auth.users
      const usersWithEmail = await Promise.all(
        (data || []).map(async (profile) => {
          const { data: authData } = await supabase.auth.admin.getUserById(
            profile.id
          );
          return {
            ...profile,
            email: authData.user?.email || "",
          };
        })
      );

      setUsers(usersWithEmail);
    } catch (error) {
      console.error("Error fetching users:", error);
    } finally {
      setLoading(false);
    }
  };

  const togglePasswordVisibility = (userId: string) => {
    setVisiblePasswords((prev) => ({
      ...prev,
      [userId]: !prev[userId],
    }));
  };

  const copyCredentials = async (
    username: string,
    password: string | null,
    userId: string
  ) => {
    const credentials = `Username: ${username}\nPassword: ${
      password || "Not available"
    }`;

    try {
      await navigator.clipboard.writeText(credentials);
      setCopiedItems((prev) => ({ ...prev, [userId]: true }));
      setTimeout(() => {
        setCopiedItems((prev) => ({ ...prev, [userId]: false }));
      }, 2000);
    } catch (err) {
      console.error("Failed to copy:", err);
    }
  };

  const handleEditPassword = (user: User) => {
    setEditingUser(user);
    setNewPassword("");
    setConfirmPassword("");
    setError("");
    setEditDialogOpen(true);
  };

  const handleUpdatePassword = async () => {
    if (!editingUser) return;

    setError("");

    // Validation
    if (newPassword.length < 6) {
      setError("Password must be at least 6 characters");
      return;
    }

    if (newPassword !== confirmPassword) {
      setError("Passwords do not match");
      return;
    }

    setUpdating(true);
    try {
      const result = await updateUserPasswordAction(
        editingUser.id,
        newPassword
      );

      if (result.error) {
        setError(result.error);
        return;
      }

      setSuccess("Password updated successfully!");
      setTimeout(() => setSuccess(""), 3000);

      // Refresh users to get updated password
      await fetchUsers();

      setEditDialogOpen(false);
      setEditingUser(null);
      setNewPassword("");
      setConfirmPassword("");
    } catch (err) {
      console.error("Error updating password:", err);
      setError("An unexpected error occurred");
    } finally {
      setUpdating(false);
    }
  };

  return (
    <DashboardLayout
      navigationItems={navigationItems}
      pageTitle="Share Credentials"
    >
      <Button
        onClick={() => router.push("/dashboard/users")}
        variant="ghost"
        className="mb-6 flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
      >
        <ArrowLeft className="w-5 h-5" />
        Back to User Management
      </Button>

      <div className="max-w-4xl">
        <div className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/20 dark:to-pink-950/20 rounded-xl p-6 border border-purple-100 dark:border-purple-900/50">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-lg bg-purple-500 dark:bg-purple-600 flex items-center justify-center">
              <Share2 className="w-5 h-5 text-white" />
            </div>
            <div>
              <h2 className="font-semibold text-gray-900 dark:text-white text-xl">
                Share User Credentials
              </h2>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                View and share login credentials with users
              </p>
            </div>
          </div>

          <div className="space-y-4">
            {loading ? (
              <p className="text-gray-500 dark:text-gray-400">Loading users...</p>
            ) : users.length === 0 ? (
              <p className="text-gray-500 dark:text-gray-400">
                No users found. Create a user first.
              </p>
            ) : (
              <div className="grid gap-4">
                {users.map((user) => (
                  <Card key={user.id} className="bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800">
                    <CardContent className="p-5">
                      <div className="flex items-start justify-between">
                        <div className="flex-1 space-y-3">
                          <div>
                            <h3 className="font-medium text-gray-900 dark:text-white text-lg">
                              {user.display_name || user.user_id}
                            </h3>
                            <p className="text-sm text-gray-500 dark:text-gray-400">{user.email}</p>
                          </div>

                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-gray-600 dark:text-gray-400 w-24">
                                User ID:
                              </span>
                              <span className="text-sm text-gray-900 dark:text-white font-mono bg-gray-100 dark:bg-neutral-800 px-3 py-1 rounded">
                                {user.user_id}
                              </span>
                              <button
                                onClick={() => copyToClipboard(user.user_id, "user_id")}
                                className="p-1 hover:bg-gray-100 dark:hover:bg-neutral-700 rounded transition-colors"
                              >
                                {copiedField === "user_id" && copiedUserId === user.id ? (
                                  <Check className="w-4 h-4 text-green-600" />
                                ) : (
                                  <Copy className="w-4 h-4 text-gray-600 dark:text-gray-400" />
                                )}
                              </button>
                            </div>

                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-gray-600 dark:text-gray-400 w-24">
                                Password:
                              </span>
                              <span className="text-sm text-gray-900 dark:text-white font-mono bg-gray-100 dark:bg-neutral-800 px-3 py-1 rounded">
                                {user.plain_password
                                  ? visiblePasswords[user.id]
                                    ? user.plain_password
                                    : "••••••••"
                                : "Not available"}
                            </span>
                            {user.plain_password && (
                              <button
                                onClick={() =>
                                  togglePasswordVisibility(user.id)
                                }
                                className="p-1 hover:bg-white rounded transition-colors"
                              >
                                {visiblePasswords[user.id] ? (
                                  <EyeOff className="w-4 h-4 text-gray-600" />
                                ) : (
                                  <Eye className="w-4 h-4 text-gray-600" />
                                )}
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Edit Password Dialog */}
      <Dialog open={editDialogOpen} onClose={() => setEditDialogOpen(false)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Edit Password</DialogTitle>
            <DialogDescription>
              Update password for{" "}
              {editingUser?.display_name || editingUser?.user_id}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            {error && (
              <div className="rounded-lg bg-red-50 p-3 border border-red-200">
                <p className="text-sm text-red-800">{error}</p>
              </div>
            )}

            <div className="space-y-2">
              <Label
                htmlFor="new_password"
                className="font-['Inter',Helvetica] font-medium text-gray-900 text-sm"
              >
                New Password <span className="text-red-500">*</span>
              </Label>
              <Input
                id="new_password"
                type="password"
                placeholder="Enter new password"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                disabled={updating}
                className="w-full h-12 bg-white rounded-lg border-2 border-gray-200 text-gray-900 px-4 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
              />
              <p className="text-xs text-gray-600">Minimum 6 characters</p>
            </div>

            <div className="space-y-2">
              <Label
                htmlFor="confirm_password"
                className="font-['Inter',Helvetica] font-medium text-gray-900 text-sm"
              >
                Confirm Password <span className="text-red-500">*</span>
              </Label>
              <Input
                id="confirm_password"
                type="password"
                placeholder="Re-enter new password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                disabled={updating}
                className="w-full h-12 bg-white rounded-lg border-2 border-gray-200 text-gray-900 px-4 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
              />
            </div>
          </div>

          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => setEditDialogOpen(false)}
              disabled={updating}
            >
              Cancel
            </Button>
            <Button
              onClick={handleUpdatePassword}
              disabled={updating}
              className="bg-blue-600 text-white hover:bg-blue-700"
            >
              {updating ? "Updating..." : "Update Password"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </DashboardLayout>
  );
}
